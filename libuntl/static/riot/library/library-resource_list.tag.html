<library-resource_item>
    <h1>{message}</h1>
    <td>
        <p each="{ label, code in opts.resource.name }">
            <span class="small">{code} </span>
            <a href="#/resources/{parent.opts.resource.id}">
                {label}
            </a>
        </p>

    </td>

    <script>
        var tag = this;
        tag.expanded = false;
        tag.on('mount', function(){})
        tag.expand = function(){
            tag.expanded = !tag.expanded;
        }

    </script>
</library-resource_item>


<library-resource_list>
    <h1>Publications</h1>

    <div class="row">
        <div class="col col-sm-3">
            <bootstrap-dropdown label="Publication Type" store="pubtype"></bootstrap-dropdown>
            <bootstrap-dropdown label="Organization" store="organization"></bootstrap-dropdown>
            <bootstrap-dropdown label="Tag" store="tag"></bootstrap-dropdown>
        </div>

        <div class="col col-sm-9">
        <bootstrap-pager page="{page}" pages="{pages}"></bootstrap-pager>
        <bootstrap-input-group placeholder="Search title..." btn="Search" trigger="search"></bootstrap-input-group>

            <div class="panel panel-default" if="{ !resources }">
                <div class="panel-heading">
                    <h3 class="panel-title">
                        There are no resources to display
                    </h3>
                </div>
            </div>
            <table class="table table-condensed table-bordered">
                <thead>
                    <tr>
                        <th>Hello</th>
                    </tr>
                </thead>
                <tbody>
                    <tr data-is="library-resource_item" each="{ resource in page_resources }" if="{resource}" resource="{resource}" ></tr>
                </tbody>
            </table>
        </div>
    </div>

    <style>
        library-resource_list .small {
            color: #a3a3a3;
        }
    </style>

    <script type="text/javascript">
        var tag = this;
        tag.page = 1;
        tag.page_size = 10;
        tag.actions = [];

        function message(message){
            tag.message = message;
            console.log(tag.message, tag)
        }

        function get_choices_pubtype(){
            return window.db.pubtypes.toArray().then(
                function(i){ return _.map(i, function(i){return [i.id , i.name.en]})}
            )
        }

        tag.get_choices_pubtype = get_choices_pubtype;

        function store(){
            return window.stores.resource;
        }

        tag.get_res = function(){
            return store().getAll()
        };


        function update(opts){
            tag.update(opts);
        }

        tag.on('update', function(){
            tag.resources = tag.resources || [];
        });

        tag.on('dropdown_select', function(drop_tag){
            _.set(tag, ['filters', drop_tag.opts.store], drop_tag.selected);
            filter();
        });

        function listener() {
            // tag.actions.push(arguments);
            // tag.update();
            var action = arguments[0];

            switch (action) {
                case 'update-start':
                    message('Downloading new resources');
                    break;
                case 'update-continued':
                    update();
                    message('Downloading new resources');
                    break;
                case 'update-end':
                    store().getAll();

                    message('Have a nice day');
                    break;
                case 'pagination':
                    tag.resources = arguments[1];
                    /* When the current page is out of range reset to 1 */
                    page();
                    break;
                case 'resources_restored':
                    update();
                    break;
                case 'load-end':
                    //store().getAll();
                    break;

                case 'detail_for':
                    console(arguments);
                    break;
                default:
                    break;
                    message(action)
            }
        }

        tag.on('change_pubtype', function(){
            console.log(arguments);
            var triggering_tag = arguments[0];
            var event = arguments[1];
            var event_name = triggering_tag.opts.event;
            var option = event.item.opt;
            var action = option[0];

            triggering_tag.update({display:option[1]});

            tag.update({page: 1, search : { type: 'equals', word: action, field: 'pubtype' }});
            page();

        });
        tag.on('search', function(){
            var triggering_tag = arguments[0];
            var event = arguments[1];
            var text = triggering_tag.refs.text.value;
            tag.update({page:1, search: {type: 'startsWithIgnoreCase', word:text, field:'searchIndex'}});
            page();
        });

        tag.header = {
            id:'id',
            description:'description',
            pubtype_id: 'Publication type'
        };

        tag.on('unmount', function(){
            store().off('*', listener);
        });

        tag.on('mount', function(){
            tag.opts = _.defaults(tag.opts, {
                page: 1,
                per_page:10
            });
            store().on('*', listener);
            store().page({page: tag.page, page_size: tag.page_size});
        });

        function filter(){
            store().getAll().then(function(objects){
                var _objects = _(objects);
                _.each(tag.filters, function(value,key) {
                    var values = _.map(value, '0');
                    if (values.length === 0 ){ return }
                    console.log(key, values);
                    _objects = _objects.filter(function (object) {
                        if (_.isArray(object[key])){return _.intersection(object[key], values).length > 0}
                        else {return _.includes(values, object[key])};
                    })
                });
                tag.resources = _objects.value();
                page();
            });
        }

        function page(){
            var pages = _.ceil(tag.resources.length / tag.page_size);
            if (tag.page > tag.pages) { tag.page = 1 }
            var page_resources = _.slice(tag.resources, (tag.page -1) * tag.page_size, tag.page * tag.page_size )
            tag.update({pages: pages, page_resources: page_resources})
        }

        tag.fn = {
            display:{
                name: function(name){return JSON.stringify(name)}
            },
            pagination: {
                next: function(e){e.preventDefault(); if (tag.page >= tag.pages) {return} tag.page += 1; page();},
                prev: function(e){e.preventDefault(); if (tag.page === 1){return} tag.page -= 1;  page();},
                first: function(e){e.preventDefault(); tag.page = 1;  page();},
                last: function(e){e.preventDefault(); tag.page = 1;  page();},
                set_page: function(e){e.preventDefault(); tag.page = e.item.page;  page();},
                back: function(){return Urls.resource_list()}
            }
        };


    </script>

</library-resource_list>

<library-resource-authors>
    <h4>Authors</h4>
    <p each="{auth in authors}"><a href="#authors/{auth.id}"> {auth.name.name} </a></p>
    <script>
        var tag = this;
        tag.items = _.map(opts.resource.author, function(i){return {name: '...'}});
        function filter(result){return _.includes(tag.opts.resource.author, result.id)}
        function setAuthor (a) {tag.update({authors:a});}
        tag.on('mount', function() {

            window.db.authors.filter(filter).toArray(setAuthor);
        })
    </script>

</library-resource-authors>

<library-resource-organizations>
     <h4>Organizations</h4>
    <p each="{item in items}"><a href="#organizations/{item.id}"> {item.name} </a></p>
    <script>
        var tag = this;
        tag.items = _.map(opts.resource.organization, function(i){return {name: '...'}});
        function filter(result){return _.includes(tag.opts.resource.organization, result.id)}
        function set (a) {tag.update({items:a})}
        tag.on('mount', function() {
            window.db.organizations.filter(filter).toArray(set);
        })
    </script>
</library-resource-organizations>
