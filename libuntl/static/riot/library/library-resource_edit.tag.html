<library-resource_edit>
    <h4> Edit Resource </h4>

    {message.id}<br>
    {message.created}<br>
    {message.modified}<br>
    {message.year}<br>
    {message.pubtype}<br>

    <hr>
    <button onclick="{save}">Save</button>
    <bootstrap-languages path="name"></bootstrap-languages>

    <h4>Tags</h4>
    <span data-is="library-resource-tag-edit" each="{tagstring in tagStrings}" tagstring="{tagstring}"></span>

    <h4>Authors</h4>

    <span data-is="library-resource-author-edit" each="{author in authors}" author="{author}"></span>

    <h4>Organizations</h4>
    <span data-is="library-resource-organization-edit" each="{organization in organizations}" organization="{organization}"></span>
    <span data-is="libary-resource-organization-add"></span>
    <hr>
    <p>{JSON.stringify(message)}</p>



    <script>
        var tag = this;
        function store(){ return window.stores.resource; }
        function filter(result){return _.includes(tag.message.author, result.id)};
        function setAuthor (a) {tag.update({authors:a})}
        function filterOrganizations(result){return _.includes(tag.message.organization, result.id)};
        function setOrganizations (a) {tag.update({organizations:a})}
        function filterTags(result){return _.includes(tag.message.tag, result.id)};
        function setTags (a) {tag.update({tagStrings:a})}
        function enrich(thing){
            // Modify the object this tag references - eg "momentize" dates
            if(!_.isUndefined(thing.modified)){thing.modified = moment(thing.modified)}
            if(!_.isUndefined(thing.created)){thing.created = moment(thing.created)}
            return thing;
        }

        tag.store = store();
        tag.message = {};
        tag.updates = {};

        tag.on('route', function(id) {
            var loading = 'now loading...';
            tag.update({
                id: id,
                message:loading,
            });
            tag.trigger('load_data');
        });

        tag.on('load_data', function(){
            var id = tag.id;
            store().find(_.toInteger(id)).then(function(thing) {
                // TODO: Handle "undefined" return from non existant resource
                tag.update({ message: enrich(thing), updates:{} });
                window.db.authors.filter(filter).toArray(setAuthor);
                window.db.organizations.filter(filterOrganizations).toArray(setOrganizations);
                window.db.tags.filter(filterTags).toArray(setTags);
            })
        });

        tag.on('on_child_input', function(e, _tag){
            var path = _tag.opts.path; // Path obtained from child tag
            var data = e.currentTarget.value;
            _.set(tag.updates, path, data);
            });

        tag.save = function(){tag.trigger('save')};
        tag.on('save', function(){
            console.log(tag.updates)
        });

    </script>
</library-resource_edit>

<library-resource-author-edit>
    <a class="btn btn-sm btn-default">{opts.author.name.name}</a>
</library-resource-author-edit>

<library-resource-organization-edit>
    <a class="btn btn-sm btn-default">{opts.organization.name}</a>
</library-resource-organization-edit>

<library-resource-tag-edit>
    <a class="btn btn-sm btn-default">{opts.tagstring.name.en}</a>
</library-resource-tag-edit>

<libary-resource-organization-add>
    <a class="btn btn-sm btn-primary">Add another organization</a>
    <script>

    </script>
</libary-resource-organization-add>